/*    Copyright (C) 2005 Robert Kooima                                       */
/*                                                                           */
/*    ELECTRO is free software;  you can redistribute it and/or modify it    */
/*    under the terms of the  GNU General Public License  as published by    */
/*    the  Free Software Foundation;  either version 2 of the License, or    */
/*    (at your option) any later version.                                    */
/*                                                                           */
/*    This program is distributed in the hope that it will be useful, but    */
/*    WITHOUT  ANY  WARRANTY;  without   even  the  implied  warranty  of    */
/*    MERCHANTABILITY or  FITNESS FOR A PARTICULAR PURPOSE.   See the GNU    */
/*    General Public License for more details.                               */

#include <stdlib.h>
#include <string.h>

#include "opengl.h"
#include "viewport.h"
#include "console.h"

#define STEP_X  8
#define STEP_Y 10

/*---------------------------------------------------------------------------*/

GLubyte glyph[96][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /*   */
    { 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18 }, /* ! */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x6c, 0x6c }, /* " */
    { 0x00, 0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c }, /* # */
    { 0x00, 0x18, 0xfc, 0x06, 0x7c, 0xc0, 0x7e, 0x18 }, /* $ */
    { 0x00, 0xc6, 0x66, 0x30, 0x18, 0xcc, 0xc6, 0x00 }, /* % */
    { 0x00, 0x76, 0xcc, 0xc6, 0x70, 0xd8, 0xd8, 0x70 }, /* & */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0x18 }, /* ' */
    { 0x00, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0c }, /* ( */
    { 0x00, 0x30, 0x18, 0x0c, 0x0c, 0x0c, 0x18, 0x30 }, /* ) */
    { 0x00, 0x00, 0x24, 0x18, 0x7e, 0x18, 0x24, 0x00 }, /* * */
    { 0x00, 0x00, 0x18, 0x18, 0x7e, 0x18, 0x18, 0x00 }, /* + */
    { 0x18, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* , */
    { 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00 }, /* - */
    { 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* . */
    { 0x00, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x00 }, /* / */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xd6, 0xc6, 0xc6, 0x7c }, /* 0 */
    { 0x00, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x38, 0x18 }, /* 1 */
    { 0x00, 0xfe, 0xc0, 0xc0, 0x7c, 0x06, 0xc6, 0x7c }, /* 2 */
    { 0x00, 0x7c, 0xc6, 0x06, 0x1c, 0x06, 0xc6, 0x7c }, /* 3 */
    { 0x00, 0x06, 0x06, 0x06, 0xfe, 0xc6, 0xc6, 0x06 }, /* 4 */
    { 0x00, 0x7c, 0xc6, 0x06, 0xfc, 0xc0, 0xc0, 0xfe }, /* 5 */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xfc, 0xc0, 0xc6, 0x7c }, /* 6 */
    { 0x00, 0x18, 0x18, 0x18, 0x0c, 0x06, 0xc6, 0xfe }, /* 7 */
    { 0x00, 0x7c, 0xc6, 0xc6, 0x7c, 0xc6, 0xc6, 0x7c }, /* 8 */
    { 0x00, 0x7c, 0xc6, 0x06, 0x7e, 0xc6, 0xc6, 0x7c }, /* 9 */
    { 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00 }, /* : */
    { 0x30, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00 }, /* ; */
    { 0x00, 0x0c, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0c }, /* < */
    { 0x00, 0x00, 0x00, 0x7e, 0x00, 0x7e, 0x00, 0x00 }, /* = */
    { 0x00, 0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60 }, /* > */
    { 0x00, 0x18, 0x18, 0x00, 0x18, 0x0c, 0xc6, 0x7c }, /* ? */
    { 0x00, 0x7c, 0xc0, 0xde, 0xd6, 0xde, 0xc6, 0x7c }, /* @ */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xfe, 0xc6, 0xc6, 0x7c }, /* A */
    { 0x00, 0xfc, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xfc }, /* B */
    { 0x00, 0x7c, 0xc6, 0xc0, 0xc0, 0xc0, 0xc6, 0x7c }, /* C */
    { 0x00, 0xfc, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xfc }, /* D */
    { 0x00, 0xfe, 0xc0, 0xc0, 0xf0, 0xc0, 0xc0, 0xfe }, /* E */
    { 0x00, 0xc0, 0xc0, 0xc0, 0xf0, 0xc0, 0xc0, 0xfe }, /* F */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xce, 0xc0, 0xc6, 0x7c }, /* G */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xfe, 0xc6, 0xc6, 0xc6 }, /* H */
    { 0x00, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c }, /* I */
    { 0x00, 0x7c, 0xc6, 0x06, 0x06, 0x06, 0x06, 0x06 }, /* J */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xc6 }, /* K */
    { 0x00, 0xfe, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0 }, /* L */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6 }, /* M */
    { 0x00, 0xc6, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0xc6 }, /* N */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c }, /* O */
    { 0x00, 0xc0, 0xc0, 0xc0, 0xfc, 0xc6, 0xc6, 0xfc }, /* P */
    { 0x00, 0x76, 0xcc, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c }, /* Q */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xfc }, /* R */
    { 0x00, 0x7c, 0xc6, 0x06, 0x7c, 0xc0, 0xc6, 0x7c }, /* S */
    { 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xfc }, /* T */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6 }, /* U */
    { 0x00, 0x10, 0x38, 0x6c, 0xc6, 0xc6, 0xc6, 0xc6 }, /* V */
    { 0x00, 0xc6, 0xee, 0xfe, 0xd6, 0xc6, 0xc6, 0xc6 }, /* W */
    { 0x00, 0xc6, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0xc6 }, /* X */
    { 0x00, 0x7c, 0xc6, 0x06, 0x7e, 0xc6, 0xc6, 0xc6 }, /* Y */
    { 0x00, 0xfe, 0x60, 0x30, 0x18, 0x0c, 0x06, 0xfe }, /* Z */
    { 0x00, 0x3c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3c }, /* [ */
    { 0x00, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x00 }, /* \ */
    { 0x00, 0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3c }, /* ] */
    { 0x00, 0x00, 0x00, 0x00, 0xc6, 0x6c, 0x38, 0x10 }, /* ^ */
    { 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* _ */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x18, 0x18 }, /* ` */
    { 0x00, 0x7e, 0xc6, 0xc6, 0xc6, 0x7e, 0x00, 0x00 }, /* a */
    { 0x00, 0xfc, 0xc6, 0xc6, 0xc6, 0xfc, 0xc0, 0xc0 }, /* b */
    { 0x00, 0x7c, 0xc6, 0xc0, 0xc6, 0x7c, 0x00, 0x00 }, /* c */
    { 0x00, 0x7e, 0xc6, 0xc6, 0xc6, 0x7e, 0x06, 0x06 }, /* d */
    { 0x00, 0x7e, 0xc0, 0xfe, 0xc6, 0x7c, 0x00, 0x00 }, /* e */
    { 0x00, 0xc0, 0xc0, 0xc0, 0xf0, 0xc0, 0xc6, 0x7c }, /* f */
    { 0x7c, 0x06, 0x7e, 0xc6, 0xc6, 0x7e, 0x00, 0x00 }, /* g */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xfc, 0xc0, 0xc0 }, /* h */
    { 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18 }, /* i */
    { 0x7c, 0xc6, 0x06, 0x06, 0x06, 0x00, 0x06, 0x06 }, /* j */
    { 0x00, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xc0, 0xc0 }, /* k */
    { 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* l */
    { 0x00, 0xd6, 0xd6, 0xd6, 0xd6, 0xfc, 0x00, 0x00 }, /* m */
    { 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xfc, 0x00, 0x00 }, /* n */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00 }, /* o */
    { 0xc0, 0xc0, 0xfc, 0xc6, 0xc6, 0xfc, 0x00, 0x00 }, /* p */
    { 0x06, 0x06, 0x7e, 0xc6, 0xc6, 0x7e, 0x00, 0x00 }, /* q */
    { 0x00, 0xc0, 0xc0, 0xc0, 0xc6, 0xfc, 0x00, 0x00 }, /* r */
    { 0x00, 0xfc, 0x06, 0x7c, 0xc0, 0x7e, 0x00, 0x00 }, /* s */
    { 0x00, 0x7c, 0xc6, 0xc0, 0xf0, 0xc0, 0xc0, 0x00 }, /* t */
    { 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0x00, 0x00 }, /* u */
    { 0x00, 0x10, 0x38, 0x6c, 0xc6, 0xc6, 0x00, 0x00 }, /* v */
    { 0x00, 0xfc, 0xd6, 0xd6, 0xd6, 0xd6, 0x00, 0x00 }, /* w */
    { 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00, 0x00 }, /* x */
    { 0x7c, 0x06, 0x7e, 0xc6, 0xc6, 0xc6, 0x00, 0x00 }, /* y */
    { 0x00, 0xfe, 0x30, 0x18, 0x0c, 0xfe, 0x00, 0x00 }, /* z */
    { 0x00, 0x0c, 0x18, 0x18, 0x30, 0x18, 0x18, 0x0c }, /* { */
    { 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* | */
    { 0x00, 0x30, 0x18, 0x18, 0x0c, 0x18, 0x18, 0x30 }, /* } */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x76 }, /* ~ */
    { 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55 }, /*  */
};

/*---------------------------------------------------------------------------*/

static int console_w;
static int console_h;
static int console_x;
static int console_y;

static unsigned char console_r = 0x00;
static unsigned char console_g = 0xFF;
static unsigned char console_b = 0x00;

static unsigned char *console;

#define CONS_C(i, j) console[(console_w * i + j) * 4]
#define CONS_R(i, j) console[(console_w * i + j) * 4 + 1]
#define CONS_G(i, j) console[(console_w * i + j) * 4 + 2]
#define CONS_B(i, j) console[(console_w * i + j) * 4 + 3]

/*---------------------------------------------------------------------------*/

static void faded(const char *str)
{
    int i, l = strlen(str);

    for (i = 0; i < l; i++)
    {
        char buf[2] = { str[i], '\0' };

        color_console((float) (l - i) / l, (float) i / l, 0.2f);
        print_console(buf);
    }
}

static void ident(void)
{
    faded("  |||  ELECTRO                           \n");
    faded("  O o  http://www.evl.uic.edu/rlk/electro\n");
    faded("   -                                     \n");
}

/*---------------------------------------------------------------------------*/

int init_console(int w, int h)
{
    w = w / STEP_X;
    h = h / STEP_Y;

    if ((console = (unsigned char *) calloc(w * h * 4, 1)))
    {
        console_w = w;
        console_h = h;
        console_x = 0;
        console_y = h - 1;

        ident();

        return 1;
    }
    return 0;
}

void draw_console(void)
{
    int i;
    int j;
    unsigned char r = 0;
    unsigned char g = 0;
    unsigned char b = 0;

    glPushAttrib(GL_ENABLE_BIT);
    {
        glColorMaterial(GL_FRONT_AND_BACK,
                        GL_AMBIENT_AND_DIFFUSE);

        glEnable(GL_COLOR_MATERIAL);
        glEnable(GL_DEPTH_TEST);
        glDisable(GL_TEXTURE_2D);
        glDisable(GL_LIGHTING);

        glMatrixMode(GL_PROJECTION);
        {
            glLoadIdentity();
            glOrtho(0, get_window_w(),
                    0, get_window_h(), -1, +1);
        }
        glMatrixMode(GL_MODELVIEW);
        {
            glLoadIdentity();
        }

        for (i = 0; i < console_h; i++)
            for (j = 0; j < console_w; j++)
                if (CONS_C(i, j))
                {
                    if (CONS_R(i, j) != r ||
                        CONS_G(i, j) != g ||
                        CONS_B(i, j) != b)
                    {
                        r = CONS_R(i, j);
                        b = CONS_B(i, j);
                        g = CONS_G(i, j);
                        glColor3ub(r, g, b);
                    }

                    glRasterPos2i(j * STEP_X, i * STEP_Y);
                    glBitmap(8, 8, 0, 0, 8, 0, glyph[CONS_C(i, j) - 32]);
                }
    }
    glPopAttrib();
}

/*---------------------------------------------------------------------------*/

static void scroll_console(void)
{
    memmove(console + console_w * 4, console, console_w * (console_h - 1) * 4);
    memset(console, 0, console_w * 4);
}

void clear_console(void)
{
    memset(console, 0, console_w * console_h * 4);
}

void color_console(float r, float g, float b)
{
    console_r = (unsigned char) (r * 255.0);
    console_g = (unsigned char) (g * 255.0);
    console_b = (unsigned char) (b * 255.0);
}

void print_console(const char *str)
{
    int i, l = strlen(str);

    for (i = 0; i < l; i++)
    {
        if (str[i] == '\n')
        {
            if (console_y == 0)
                scroll_console();
            else
                console_y = console_y - 1;
            
            console_x = 0;
        }
        if (str[i] >= 32)
        {
            if (0 <= console_x && console_x < console_w &&
                0 <= console_y && console_y < console_h)
            {
                CONS_C(console_y, console_x) = str[i];
                CONS_R(console_y, console_x) = console_r;
                CONS_G(console_y, console_x) = console_g;
                CONS_B(console_y, console_x) = console_b;
            }
            console_x = console_x + 1;
        }
    }
}

/*---------------------------------------------------------------------------*/
